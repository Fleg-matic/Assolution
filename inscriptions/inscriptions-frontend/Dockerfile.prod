# Multi-stage build pour Production - Assolution Frontend
FROM node:22-alpine AS builder

# Variables d'environnement pour le build
ENV NODE_ENV=development
ENV NG_CLI_ANALYTICS=false

# Installation des outils de build + envsubst pour substitution de variables
RUN apk add --no-cache git python3 make g++ curl bash gettext

WORKDIR /build

# Copie des fichiers de dÃ©pendances
COPY package*.json ./

# âœ… Installation des dÃ©pendances avec versions TypeScript compatibles
RUN npm ci --no-audit --no-fund && \
    npm install --save-dev @angular/cli@20.1.5 && \
    npm install --save-dev @angular-devkit/build-angular@20.1.5 && \
    npm install --save-dev @angular/compiler-cli@20.1.6 && \
    npm install --save-dev typescript@5.8.3

# âœ… COPIE DU TEMPLATE depuis le contexte de build (racine du mono-repo)
COPY config-templates/environment.prod.ts.template /tmp/environment.prod.ts.template

# Copie du code source du frontend
COPY inscriptions/inscriptions-frontend/ .

# âœ… SUBSTITUTION DES VARIABLES D'ENVIRONNEMENT - SOLUTION CORRIGÃ‰E
RUN echo "ğŸ”§ Processing environment variables from template..." && \
    if [ -f "/tmp/environment.prod.ts.template" ]; then \
        echo "ğŸ“ Substituting variables from config-templates..." && \
        echo "ğŸ” Template content preview:" && \
        head -10 /tmp/environment.prod.ts.template && \
        echo "..." && \
        echo "ğŸ”„ Running envsubst..." && \
        envsubst < /tmp/environment.prod.ts.template > src/environments/environment.prod.ts && \
        echo "âœ… Environment file generated from template:" && \
        head -20 src/environments/environment.prod.ts && \
        echo "ğŸ“Š File size: $(wc -l < src/environments/environment.prod.ts) lines" && \
        echo "ğŸ” Variables substituted:" && \
        grep -o '\${[^}]*}' /tmp/environment.prod.ts.template | sort | uniq || echo "No variables found in template"; \
    elif [ ! -f "src/environments/environment.prod.ts" ]; then \
        echo "âš ï¸  Template not found, creating minimal fallback environment.prod.ts..." && \
        echo 'export const environment = {' | tee src/environments/environment.prod.ts > /dev/null && \
        echo '  production: true,' | tee -a src/environments/environment.prod.ts > /dev/null && \
        echo "  apiUrl: '/api'," | tee -a src/environments/environment.prod.ts > /dev/null && \
        echo "  appName: 'Assolution'," | tee -a src/environments/environment.prod.ts > /dev/null && \
        echo "  appVersion: '1.0.0'" | tee -a src/environments/environment.prod.ts > /dev/null && \
        echo '};' | tee -a src/environments/environment.prod.ts > /dev/null && \
        echo "âš ï¸  Fallback environment created"; \
    else \
        echo "âœ… environment.prod.ts already exists, content preview:" && \
        head -10 src/environments/environment.prod.ts; \
    fi

# VÃ©rification du fichier gÃ©nÃ©rÃ©
RUN echo "ğŸ” VERIFICATION FINALE environment.prod.ts:" && \
    if [ -f "src/environments/environment.prod.ts" ]; then \
        echo "âœ… File exists" && \
        echo "ğŸ“Š Size: $(wc -l < src/environments/environment.prod.ts) lines, $(wc -c < src/environments/environment.prod.ts) bytes" && \
        echo "ğŸ” First 5 lines:" && \
        head -5 src/environments/environment.prod.ts && \
        echo "ğŸ” Checking for syntax errors..." && \
        node -c src/environments/environment.prod.ts && echo "âœ… Syntax OK" || echo "âŒ Syntax error detected" && \
        echo "ğŸ“Š TypeScript version: $(npx tsc --version)" && \
        echo "âœ… Environment and TypeScript ready for build"; \
    else \
        echo "âŒ environment.prod.ts file missing!" && exit 1; \
    fi

# âœ… BUILD ANGULAR avec gestion d'erreurs amÃ©liorÃ©e
RUN echo "ğŸ¯ Building Angular application..." && \
    echo "ğŸ“Š Node version: $(node --version)" && \
    echo "ğŸ“Š NPM version: $(npm --version)" && \
    echo "ğŸ“Š Available memory: $(free -h | grep Mem | awk '{print $2}')" && \
    echo "ğŸš€ Starting build process..." && \
    npm run build:prod && \
    echo "âœ… Angular build completed successfully!"

# Diagnostic complet de la structure de build
RUN echo "ğŸ” DIAGNOSTIC COMPLET BUILD STRUCTURE:" && \
    echo "ğŸ“ Root /build contents:" && \
    ls -la /build/ && \
    echo "" && \
    echo "ğŸ“ Contents of /build/dist:" && \
    ls -la /build/dist/ 2>/dev/null || echo "âŒ No dist directory found" && \
    echo "" && \
    echo "ğŸ“ Searching for index.html recursively:" && \
    find /build -name "index.html" -type f 2>/dev/null || echo "âŒ No index.html found" && \
    echo "" && \
    echo "ğŸ“ Searching for main.*.js files:" && \
    find /build -name "main.*.js" -type f 2>/dev/null || echo "âŒ No main.js files found"

# Copie intelligente et robuste des fichiers buildÃ©s
RUN echo "ğŸ“¦ SMART COPY OF BUILD ARTIFACTS:" && \
    mkdir -p /build/final_dist && \
    BUILD_COPIED=false && \
    if [ -f "/build/dist/inscriptions-frontend/browser/index.html" ]; then \
        echo "âœ… Method 1: Found Angular 17+ files in browser subdirectory" && \
        cp -r /build/dist/inscriptions-frontend/browser/* /build/final_dist/ && \
        BUILD_COPIED=true; \
    elif [ -f "/build/dist/inscriptions-frontend/index.html" ]; then \
        echo "âœ… Method 2: Found Angular files in project subdirectory" && \
        cp -r /build/dist/inscriptions-frontend/* /build/final_dist/ && \
        BUILD_COPIED=true; \
    elif [ -f "/build/dist/browser/index.html" ]; then \
        echo "âœ… Method 3: Found Angular files in browser directory" && \
        cp -r /build/dist/browser/* /build/final_dist/ && \
        BUILD_COPIED=true; \
    elif [ -f "/build/dist/index.html" ]; then \
        echo "âœ… Method 4: Found Angular files in root dist" && \
        cp -r /build/dist/* /build/final_dist/ && \
        BUILD_COPIED=true; \
    else \
        echo "âš ï¸  Method 5: Fallback - copying all dist content..." && \
        if [ -d "/build/dist" ]; then \
            cp -r /build/dist/* /build/final_dist/ 2>/dev/null || true && \
            BUILD_COPIED=true; \
        fi; \
    fi && \
    if [ "$BUILD_COPIED" = "true" ]; then \
        echo "âœ… Build artifacts copied successfully" && \
        echo "ğŸ“Š Final dist file count: $(find /build/final_dist -type f 2>/dev/null | wc -l)" && \
        echo "ğŸ“Š Final dist size: $(du -sh /build/final_dist 2>/dev/null | cut -f1 || echo 'unknown')" && \
        echo "ğŸ” Key files present:" && \
        ls -la /build/final_dist/index.html 2>/dev/null || echo "âŒ index.html missing" && \
        ls -la /build/final_dist/main.*.js 2>/dev/null | head -3 || echo "âŒ main.js files missing"; \
    else \
        echo "âŒ CRITICAL: No build artifacts could be copied!" && \
        exit 1; \
    fi

# Stage final - Production runtime
FROM alpine:3.19 AS production

# Installation des outils nÃ©cessaires pour le runtime
RUN apk add --no-cache curl bash && \
    rm -rf /var/cache/apk/* && \
    mkdir -p /app/dist

# Copie des fichiers buildÃ©s depuis le stage builder
COPY --from=builder /build/final_dist/ /app/dist/

# VÃ©rification finale des fichiers copiÃ©s
RUN echo "ğŸ” FINAL PRODUCTION VERIFICATION:" && \
    echo "ğŸ“Š Files in production: $(find /app/dist -type f | wc -l)" && \
    echo "ğŸ“Š Total size: $(du -sh /app/dist | cut -f1)" && \
    echo "ğŸ” Critical files check:" && \
    ls -la /app/dist/index.html 2>/dev/null && echo "âœ… index.html OK" || echo "âŒ index.html MISSING" && \
    ls -la /app/dist/*.js 2>/dev/null | head -3 && echo "âœ… JS files OK" || echo "âŒ JS files MISSING" && \
    ls -la /app/dist/*.css 2>/dev/null | head -3 && echo "âœ… CSS files OK" || echo "âš ï¸  CSS files missing (may be normal)"

# Script de vÃ©rification et dÃ©marrage
RUN echo '#!/bin/bash' > /app/verify.sh && \
    echo 'echo "ğŸš€ Assolution Frontend - Production Ready"' >> /app/verify.sh && \
    echo 'echo "ğŸ“… Built on: $(date)"' >> /app/verify.sh && \
    echo 'echo "ğŸ“Š Files: $(find /app/dist -type f | wc -l)"' >> /app/verify.sh && \
    echo 'echo "ğŸ“Š Size: $(du -sh /app/dist | cut -f1)"' >> /app/verify.sh && \
    echo 'echo "ğŸ“ Directory contents:"' >> /app/verify.sh && \
    echo 'ls -la /app/dist/' >> /app/verify.sh && \
    echo 'echo "âœ… Frontend static files ready for Nginx"' >> /app/verify.sh && \
    echo 'tail -f /dev/null' >> /app/verify.sh && \
    chmod +x /app/verify.sh

WORKDIR /app/dist
ENTRYPOINT ["/app/verify.sh"]