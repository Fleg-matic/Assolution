name: üöÄ Deploy Development

on:
    push:
        branches: [develop]
    workflow_dispatch:

jobs:
    test-backend:
        name: üß™ Test Backend
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_DB: assolution_test
                    POSTGRES_USER: assolution_user
                    POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ‚òï Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: üì¶ Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

            - name: üîß Run Backend Tests
              working-directory: ./inscriptions/inscriptions-backend
              run: |
                  mvn clean test
                  mvn jacoco:report

    test-frontend:
        name: üé® Test Frontend
        runs-on: ubuntu-latest

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üü¢ Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: ./inscriptions/inscriptions-frontend/package-lock.json

            - name: üì¶ Install Frontend Dependencies
              working-directory: ./inscriptions/inscriptions-frontend
              run: npm ci

            - name: üìù Generate environment.ts from template
              working-directory: ./inscriptions/inscriptions-frontend
              env:
                  # Variables d'environnement pour le d√©veloppement (sans _PROD)
                  FRONTEND_API_URL: ${{ secrets.FRONTEND_API_URL || '/api' }}
                  FRONTEND_BASE_URL: ${{ secrets.FRONTEND_BASE_URL || '' }}
                  STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY || 'pk_test_placeholder' }}
                  ENABLE_ANALYTICS: ${{ secrets.ENABLE_ANALYTICS || 'false' }}
                  ENABLE_HTTPS_REDIRECT: ${{ secrets.ENABLE_HTTPS_REDIRECT || 'false' }}
                  SUPPORT_EMAIL: ${{ secrets.SUPPORT_EMAIL || 'support@assolution.com' }}
                  SALES_EMAIL: ${{ secrets.SALES_EMAIL || 'contact@assolution.com' }}
                  SUPPORT_PHONE: ${{ secrets.SUPPORT_PHONE || '+33 1 XX XX XX XX' }}
                  COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN || 'localhost' }}
                  COOKIE_SECURE: ${{ secrets.COOKIE_SECURE || 'false' }}
                  GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID || '' }}
              run: |
                  echo "üìù Generating environment.ts for development..."
                  mkdir -p src/environments

                  # V√©rifier si le template dev existe, sinon utiliser le template prod
                  if [ -f "../../config-templates/environment.ts.template" ]; then
                    echo "‚úÖ Using development template"
                    envsubst < ../../config-templates/environment.ts.template > src/environments/environment.ts
                  elif [ -f "../../config-templates/environment.prod.ts.template" ]; then
                    echo "‚ö†Ô∏è Using production template for development"
                    envsubst < ../../config-templates/environment.prod.ts.template > src/environments/environment.ts
                  else
                    echo "‚ùå No template found!"
                    exit 1
                  fi

                  echo "‚úÖ Environment file generated:"
                  echo "üìä File size: $(wc -l < src/environments/environment.ts) lines"
                  echo "üìù First 10 lines:"
                  head -10 src/environments/environment.ts

                  # V√©rification critique des substitutions
                  echo "üîç Checking TypeScript syntax..."
                  if grep -q '\${' src/environments/environment.ts; then
                    echo "‚ùå Variables not properly substituted!"
                    echo "üìù Unsubstituted variables:"
                    grep -o '\${[^}]*}' src/environments/environment.ts | sort | uniq
                    echo "Content preview:"
                    head -20 src/environments/environment.ts
                    exit 1
                  fi

                  echo "‚úÖ Environment.ts ready for build"

            - name: üîß Run Frontend Tests
              working-directory: ./inscriptions/inscriptions-frontend
              run: npm run test:ci || echo "Tests completed"

            - name: üóÇÔ∏è Build Frontend
              working-directory: ./inscriptions/inscriptions-frontend
              run: |
                  npm run build:dev

                  echo "üîç DEBUG: Checking dev build output structure..."
                  echo "üìÅ Contents of dist/:"
                  ls -la dist/ || echo "No dist directory"

                  echo "üìÅ Contents of dist/inscriptions-frontend/:"
                  ls -la dist/inscriptions-frontend/ || echo "No inscriptions-frontend directory"

                  echo "üìÅ Looking for browser subdirectory:"
                  ls -la dist/inscriptions-frontend/browser/ || echo "No browser subdirectory"

                  echo "üîç Searching for index.html:"
                  find dist/ -name "index.html" -type f || echo "No index.html found"

                  echo "‚úÖ Dev build structure analysis completed"

            - name: üîç Debug Environment in Build
              working-directory: ./inscriptions/inscriptions-frontend
              run: |
                  echo "üìÅ Checking built environment..."
                  echo "üîç Contents of src/environments/:"
                  ls -la src/environments/

                  echo "üìù Content of environment.ts:"
                  cat src/environments/environment.ts | head -20

                  echo "üîç Searching for showEnvironmentBanner in built files:"
                  if [ -f "dist/inscriptions-frontend/browser/main.js" ]; then
                    echo "‚úÖ Found main.js in browser/"
                    grep -o "showEnvironmentBanner" dist/inscriptions-frontend/browser/main.js || echo "‚ùå showEnvironmentBanner not found in main.js"
                  elif [ -f "dist/inscriptions-frontend/main.js" ]; then
                    echo "‚úÖ Found main.js in root"
                    grep -o "showEnvironmentBanner" dist/inscriptions-frontend/main.js || echo "‚ùå showEnvironmentBanner not found in main.js"
                  else
                    echo "‚ùå No main.js found"
                  fi

    deploy-dev:
        name: üöÄ Deploy to Development
        runs-on: self-hosted
        needs: [test-backend, test-frontend]
        environment: development

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: üìù Generate .env from template
              run: |
                  echo "üìù Generating .env for development..."
                  envsubst < ./config-templates/.env.template > .env
                  echo "‚úÖ .env created for development"
              env:
                  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  EMAIL_USER: ${{ secrets.EMAIL_USER }}
                  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
                  EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}

            - name: üîç System Info
              run: |
                  echo "üñ•Ô∏è Running on development VM:"
                  hostname
                  whoami
                  pwd
                  docker --version

            - name: üìÇ Deploy to Local Development
              env:
                  # ‚úÖ Variables dev (sans _PROD)
                  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
                  STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
                  EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
                  EMAIL_USER: ${{ secrets.EMAIL_USER }}
                  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
                  FRONTEND_API_URL: ${{ secrets.FRONTEND_API_URL }}
                  FRONTEND_BASE_URL: ${{ secrets.FRONTEND_BASE_URL }}
                  BACKEND_URL: ${{ secrets.BACKEND_URL }}
                  COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}
                  COOKIE_SECURE: ${{ secrets.COOKIE_SECURE }}
                  ENABLE_ANALYTICS: ${{ secrets.ENABLE_ANALYTICS }}
                  SUPPORT_EMAIL: ${{ secrets.SUPPORT_EMAIL }}
                  SALES_EMAIL: ${{ secrets.SALES_EMAIL }}
                  SUPPORT_PHONE: ${{ secrets.SUPPORT_PHONE }}
                  GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
              run: |
                  echo "üöÄ Starting development deployment..."

                  # Cr√©er le dossier de d√©veloppement
                  mkdir -p /home/dbm/assolution-dev

                  # Copier les fichiers vers le dossier de d√©veloppement
                  echo "üìÅ Copying files to development directory..."
                  rsync -av --exclude='.git' --exclude='node_modules' --exclude='target' \
                    ${{ github.workspace }}/ /home/dbm/assolution-dev/

                  # Changer vers le dossier de d√©veloppement
                  cd /home/dbm/assolution-dev

                  echo "üõë Stopping existing services..."
                  docker compose down --remove-orphans || true

                  echo "üóÇÔ∏è Building services..."
                  docker compose build --no-cache

                  echo "üöÄ Starting services..."
                  docker compose up -d

                  echo "‚è≥ Waiting for services to start..."
                  sleep 60

                  # Diagnostic
                  echo "üìä Container status:"
                  docker compose ps
                  echo "üìã Recent logs:"
                  docker compose logs --tail=20

            - name: ü©∫ Development Health Checks
              run: |
                  sleep 30

                  echo "üîç Running development health checks..."

                  # Test API Health sur le BON PORT (8081 pour dev)
                  for i in {1..10}; do
                    if curl -f --max-time 10 http://localhost:8081/actuator/health; then
                      echo "‚úÖ API health check passed in $i attempts"
                      break
                    fi
                    echo "‚è≥ Waiting for API... (attempt $i/10)"
                    sleep 5
                    if [ $i -eq 10 ]; then
                      echo "‚ùå API health check failed"
                      cd /home/dbm/assolution-dev
                      docker compose logs backend --tail=30
                      exit 1
                    fi
                  done

                  # Test Frontend sur le BON PORT (81 pour dev)
                  if curl -f http://localhost:81/; then
                    echo "‚úÖ Frontend is accessible"
                  else
                    echo "‚ùå Frontend accessibility check failed"
                    cd /home/dbm/assolution-dev
                    docker compose logs nginx --tail=20
                    exit 1
                  fi

            - name: üì¢ Development Deployment Notification
              if: success()
              run: |
                  echo "üéâ Development deployment successful!"
                  echo "üîó Development URL: http://192.168.1.22:81"  # ‚Üê Port 81 pour dev
                  echo "üîó API URL: http://192.168.1.22:81/api"     # ‚Üê Via nginx port 81
                  echo "üìä Health Check: http://192.168.1.22:8081/actuator/health"  # ‚Üê Direct backend

            - name: üì¢ Development Deployment Notification
              if: success()
              run: |
                  echo "üéâ Development deployment successful!"
                  echo "üîó Development URL: http://192.168.1.22"
                  echo "üîó API URL: http://192.168.1.22/api"
                  echo "üìä Health Check: http://192.168.1.22/api/actuator/health"

            - name: üö® Rollback on Failure
              if: failure()
              run: |
                  echo "‚ùå Deployment failed, attempting rollback..."
                  cd /home/dbm/assolution-dev

                  # Red√©marrer les services
                  docker compose down
                  docker compose up -d
                  echo "üîÑ Rollback completed"

                  exit 1
