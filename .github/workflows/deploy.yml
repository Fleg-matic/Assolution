name: ğŸš€ Deploy Development

on:
    push:
        branches: [develop]
    workflow_dispatch:

jobs:
    test-backend:
        name: ğŸ§ª Test Backend
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_DB: assolution_test
                    POSTGRES_USER: assolution_user
                    POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: â˜• Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: ğŸ“¦ Cache Maven dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

            - name: ğŸ”§ Run Backend Tests
              working-directory: ./inscriptions/inscriptions-backend
              run: |
                  mvn clean test
                  mvn jacoco:report

    test-frontend:
        name: ğŸ¨ Test Frontend
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: ./inscriptions/inscriptions-frontend/package-lock.json

            - name: ğŸ“¦ Install Frontend Dependencies
              working-directory: ./inscriptions/inscriptions-frontend
              run: npm ci

            - name: ğŸ”§ Run Frontend Tests
              working-directory: ./inscriptions/inscriptions-frontend
              run: npm run test:ci || echo "Tests completed"

            - name: ğŸ—‚ï¸ Build Frontend
              working-directory: ./inscriptions/inscriptions-frontend
              run: |
                  npm run build:dev

                  echo "ğŸ” DEBUG: Checking dev build output structure..."
                  echo "ğŸ“ Contents of dist/:"
                  ls -la dist/ || echo "No dist directory"

                  echo "ğŸ“ Contents of dist/inscriptions-frontend/:"
                  ls -la dist/inscriptions-frontend/ || echo "No inscriptions-frontend directory"

                  echo "ğŸ“ Looking for browser subdirectory:"
                  ls -la dist/inscriptions-frontend/browser/ || echo "No browser subdirectory"

                  echo "ğŸ” Searching for index.html:"
                  find dist/ -name "index.html" -type f || echo "No index.html found"

                  echo "âœ… Dev build structure analysis completed"

    deploy-dev:
        name: ğŸš€ Deploy to Development
        runs-on: self-hosted
        needs: [test-backend, test-frontend]
        environment: development

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸ” System Info
              run: |
                  echo "ğŸ–¥ï¸ Running on development VM:"
                  hostname
                  whoami
                  pwd
                  docker --version

            - name: ğŸ“‚ Deploy to Local Development
              env:
                  # âœ… Variables dev (sans _PROD)
                  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
                  STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
                  EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
                  EMAIL_USER: ${{ secrets.EMAIL_USER }}
                  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
                  FRONTEND_API_URL: ${{ secrets.FRONTEND_API_URL }}
                  FRONTEND_BASE_URL: ${{ secrets.FRONTEND_BASE_URL }}
                  BACKEND_URL: ${{ secrets.BACKEND_URL }}
                  COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}
                  COOKIE_SECURE: ${{ secrets.COOKIE_SECURE }}
                  ENABLE_ANALYTICS: ${{ secrets.ENABLE_ANALYTICS }}
                  SUPPORT_EMAIL: ${{ secrets.SUPPORT_EMAIL }}
                  SALES_EMAIL: ${{ secrets.SALES_EMAIL }}
                  SUPPORT_PHONE: ${{ secrets.SUPPORT_PHONE }}
                  GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
              run: |
                  echo "ğŸš€ Starting development deployment..."

                  # CrÃ©er le dossier de dÃ©veloppement
                  mkdir -p /home/dbm/assolution-dev

                  # Copier les fichiers vers le dossier de dÃ©veloppement
                  echo "ğŸ“ Copying files to development directory..."
                  rsync -av --exclude='.git' --exclude='node_modules' --exclude='target' \
                    ${{ github.workspace }}/ /home/dbm/assolution-dev/

                  # Changer vers le dossier de dÃ©veloppement
                  cd /home/dbm/assolution-dev

                  echo "ğŸ›‘ Stopping existing services..."
                  docker compose down --remove-orphans || true

                  echo "ğŸ—‚ï¸ Building services..."
                  docker compose build --no-cache

                  echo "ğŸš€ Starting services..."
                  docker compose up -d

                  echo "â³ Waiting for services to start..."
                  sleep 60

                  # Diagnostic
                  echo "ğŸ“Š Container status:"
                  docker compose ps
                  echo "ğŸ“‹ Recent logs:"
                  docker compose logs --tail=20

            - name: ğŸ©º Development Health Checks
              run: |
                  sleep 30

                  echo "ğŸ” Running development health checks..."

                  # Test API Health sur le BON PORT (8081 pour dev)
                  for i in {1..10}; do
                    if curl -f --max-time 10 http://localhost:8081/actuator/health; then
                      echo "âœ… API health check passed in $i attempts"
                      break
                    fi
                    echo "â³ Waiting for API... (attempt $i/10)"
                    sleep 5
                    if [ $i -eq 10 ]; then
                      echo "âŒ API health check failed"
                      cd /home/dbm/assolution-dev
                      docker compose logs backend --tail=30
                      exit 1
                    fi
                  done

                  # Test Frontend sur le BON PORT (81 pour dev)
                  if curl -f http://localhost:81/; then
                    echo "âœ… Frontend is accessible"
                  else
                    echo "âŒ Frontend accessibility check failed"
                    cd /home/dbm/assolution-dev
                    docker compose logs nginx --tail=20
                    exit 1
                  fi

            - name: ğŸ“¢ Development Deployment Notification
              if: success()
              run: |
                  echo "ğŸ‰ Development deployment successful!"
                  echo "ğŸ”— Development URL: http://192.168.1.22:81"  # â† Port 81 pour dev
                  echo "ğŸ”— API URL: http://192.168.1.22:81/api"     # â† Via nginx port 81
                  echo "ğŸ“Š Health Check: http://192.168.1.22:8081/actuator/health"  # â† Direct backend

            - name: ğŸ“¢ Development Deployment Notification
              if: success()
              run: |
                  echo "ğŸ‰ Development deployment successful!"
                  echo "ğŸ”— Development URL: http://192.168.1.22"
                  echo "ğŸ”— API URL: http://192.168.1.22/api"
                  echo "ğŸ“Š Health Check: http://192.168.1.22/api/actuator/health"

            - name: ğŸš¨ Rollback on Failure
              if: failure()
              run: |
                  echo "âŒ Deployment failed, attempting rollback..."
                  cd /home/dbm/assolution-dev

                  # RedÃ©marrer les services
                  docker compose down
                  docker compose up -d
                  echo "ğŸ”„ Rollback completed"

                  exit 1
